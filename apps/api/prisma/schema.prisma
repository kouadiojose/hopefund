// Hopefund Banking System - Prisma Schema
// Connecté à la base PostgreSQL existante sur DigitalOcean

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TABLES PRINCIPALES - Mappées sur l'existant
// ============================================

/// Table des clients (personnes physiques et morales)
model Client {
  id_client                  Int       @id @default(autoincrement())
  id_ag                      Int
  anc_id_client              String?
  statut_juridique           Int?      // 1=Personne physique, 2=Personne morale
  qualite                    Int?
  adresse                    String?
  code_postal                String?
  ville                      String?
  pays                       Int?
  num_tel                    String?
  num_port                   String?
  email                      String?
  date_adh                   DateTime?
  etat                       Int?      // 1=Actif, 2=Inactif, etc.

  // Personne physique (pp_*)
  pp_nom                     String?
  pp_prenom                  String?
  pp_date_naissance          DateTime?
  pp_lieu_naissance          String?
  pp_sexe                    Int?      // 1=Masculin, 2=Féminin
  pp_nationalite             Int?
  pp_type_piece_id           Int?
  pp_nm_piece_id             String?
  pp_etat_civil              Int?
  pp_nbre_enfant             Int?
  pp_employeur               String?
  pp_fonction                String?
  pp_revenu                  Decimal?  @db.Decimal(30, 6)

  // Personne morale (pm_*)
  pm_raison_sociale          String?
  pm_abreviation             String?
  pm_nature_juridique        String?
  pm_numero_reg_nat          String?
  pm_date_constitution       DateTime?

  // Groupe informel (gi_*)
  gi_nom                     String?
  gi_nbre_membr              Int?

  // Géographie
  province                   Int?
  district                   Int?
  secteur                    Int?
  cellule                    Int?
  village                    Int?

  // Métadonnées
  date_creation              DateTime  @default(now())
  date_modif                 DateTime?
  utilis_crea                Int?
  utilis_modif               Int?
  nbre_credits               Int?      @default(0)

  // Relations
  comptes                    Compte[]
  dossiers_credit            DossierCredit[]

  @@unique([id_client, id_ag])
  @@index([id_ag])
  @@index([pp_nom, pp_prenom])
  @@index([num_tel])
  @@map("ad_cli")
}

/// Table des comptes clients
model Compte {
  id_cpte                    Int       @id @default(autoincrement())
  id_ag                      Int
  id_titulaire               Int
  id_prod                    Int?      // Type de produit d'épargne
  num_cpte                   Int?
  num_complet_cpte           String?   @unique
  num_cpte_comptable         String?   @db.VarChar(50)
  intitule_compte            String?
  devise                     String?   @db.Char(3)

  // Soldes
  solde                      Decimal?  @db.Decimal(30, 6) @default(0)
  mnt_bloq                   Decimal?  @db.Decimal(30, 6) @default(0)
  mnt_min_cpte               Decimal?  @db.Decimal(30, 6) @default(0)
  decouvert_max              Decimal?  @db.Decimal(30, 6) @default(0)

  // Intérêts
  tx_interet_cpte            Float?
  interet_annuel             Decimal?  @db.Decimal(30, 6) @default(0)
  solde_calcul_interets      Decimal?  @db.Decimal(30, 6) @default(0)
  date_solde_calcul_interets DateTime?
  mode_calcul_int_cpte       Int?

  // État
  etat_cpte                  Int?      // 1=Actif, 2=Bloqué, 3=Dormant, 4=Clôturé
  date_ouvert                DateTime?
  date_clot                  DateTime?
  raison_clot                Int?

  // Chèques
  etat_chequier              Int?      @default(0)
  chequier_num_cheques       Int?      @default(25)
  num_last_cheque            Int?      @default(0)

  // Métadonnées
  date_creation              DateTime  @default(now())
  date_modif                 DateTime?
  utilis_crea                Int?

  // Relations
  titulaire                  Client    @relation(fields: [id_titulaire, id_ag], references: [id_client, id_ag])
  mouvements                 Mouvement[]

  @@unique([id_cpte, id_ag])
  @@index([id_ag])
  @@index([id_titulaire])
  @@map("ad_cpt")
}

/// Table des dossiers de crédit
model DossierCredit {
  id_doss                    Int       @id @default(autoincrement())
  id_ag                      Int
  id_client                  Int
  id_prod                    Int?      // Type de produit crédit

  // Demande
  date_dem                   DateTime?
  mnt_dem                    Decimal?  @db.Decimal(30, 6) @default(0)
  obj_dem                    Int?      // Objet du crédit
  detail_obj_dem             String?
  duree_mois                 Int?

  // Crédit octroyé
  cre_mnt_octr               Decimal?  @db.Decimal(30, 6) @default(0)
  cre_date_approb            DateTime?
  cre_date_debloc            DateTime?
  cre_etat                   Int?      // État du crédit
  cre_id_cpte                Int?      // Compte de déblocage

  // Conditions
  terme                      Int?
  delai_grac                 Int?      @default(0)
  differe_jours              Int?      @default(0)
  tx_interet_lcr             Float?    @default(0)

  // Garanties
  gar_num                    Decimal?  @db.Decimal(30, 6) @default(0)
  gar_tot                    Decimal?  @db.Decimal(30, 6) @default(0)
  gar_mat                    Decimal?  @db.Decimal(30, 6) @default(0)

  // Gestion
  id_agent_gest              Int?
  etat                       Int?      // État du dossier
  date_etat                  DateTime?
  motif                      Int?

  // Assurances et frais
  mnt_assurance              Decimal?  @db.Decimal(30, 6) @default(0)
  mnt_commission             Decimal?  @db.Decimal(30, 6) @default(0)
  mnt_frais_doss             Decimal?  @db.Decimal(30, 6) @default(0)

  // Provisions
  prov_mnt                   Decimal?  @db.Decimal(30, 6) @default(0)
  prov_date                  DateTime?
  perte_capital              Decimal?  @db.Decimal(30, 6) @default(0)

  // Métadonnées
  date_creation              DateTime  @default(now())
  date_modif                 DateTime?

  // Relations
  client                     Client    @relation(fields: [id_client, id_ag], references: [id_client, id_ag])
  echeances                  Echeance[]
  garanties                  Garantie[]

  @@unique([id_doss, id_ag])
  @@index([id_ag])
  @@index([id_client])
  @@index([etat])
  @@index([cre_etat])
  @@map("ad_dcr")
}

/// Table des mouvements/transactions
model Mouvement {
  id_mouvement               Int       @id @default(autoincrement())
  id_ag                      Int
  cpte_interne_cli           Int?

  date_mvt                   DateTime?
  type_mvt                   Int?      // 1=Crédit, 2=Débit
  sens                       String?   @db.Char(1)
  montant                    Decimal?  @db.Decimal(30, 6)
  solde_avant                Decimal?  @db.Decimal(30, 6)
  solde_apres                Decimal?  @db.Decimal(30, 6)

  libel_mvt                  String?
  type_operation             Int?
  id_utilisateur             Int?

  date_creation              DateTime  @default(now())

  // Relations - optionnelle car cpte_interne_cli peut être NULL
  compte                     Compte?   @relation(fields: [cpte_interne_cli, id_ag], references: [id_cpte, id_ag])

  @@index([id_ag])
  @@index([cpte_interne_cli])
  @@index([date_mvt])
  @@map("ad_mouvement")
}

/// Table des échéances de remboursement
model Echeance {
  id_ech                     Int       @id @default(autoincrement())
  id_ag                      Int
  id_doss                    Int

  num_ech                    Int?
  date_ech                   DateTime?

  mnt_capital                Decimal?  @db.Decimal(30, 6) @default(0)
  mnt_int                    Decimal?  @db.Decimal(30, 6) @default(0)

  solde_capital              Decimal?  @db.Decimal(30, 6) @default(0)
  solde_int                  Decimal?  @db.Decimal(30, 6) @default(0)

  date_paiement              DateTime?
  mnt_paye                   Decimal?  @db.Decimal(30, 6) @default(0)

  etat                       Int?      // 1=Non échu, 2=Payé, 3=Impayé

  // Relations
  dossier                    DossierCredit @relation(fields: [id_doss, id_ag], references: [id_doss, id_ag])

  @@index([id_ag])
  @@index([id_doss])
  @@index([date_ech])
  @@map("ad_sre")
}

/// Table des garanties
model Garantie {
  id_gar                     Int       @id @default(autoincrement())
  id_ag                      Int
  id_doss                    Int

  type_gar                   Int?      // Type de garantie
  description                String?
  valeur_estimee             Decimal?  @db.Decimal(30, 6)
  date_evaluation            DateTime?

  // Relations
  dossier                    DossierCredit @relation(fields: [id_doss, id_ag], references: [id_doss, id_ag])

  @@index([id_ag])
  @@index([id_doss])
  @@map("ad_gar")
}

/// Table des agences
model Agence {
  id_ag                      Int       @id
  libel_ag                   String?
  adresse_ag                 String?
  tel_ag                     String?
  email_ag                   String?

  date_creation              DateTime  @default(now())
  etat_ag                    Int?      @default(1)

  @@map("ad_agc")
}

// ============================================
// TABLES NOUVELLES - Pour l'application
// ============================================

/// Utilisateurs du système (staff)
model User {
  id                         Int       @id @default(autoincrement())
  email                      String    @unique
  password_hash              String

  nom                        String
  prenom                     String
  telephone                  String?

  role                       String    @default("TELLER")
  id_ag                      Int?      // Agence assignée

  is_active                  Boolean   @default(true)
  last_login                 DateTime?
  failed_attempts            Int       @default(0)
  locked_until               DateTime?

  created_at                 DateTime  @default(now())
  updated_at                 DateTime  @updatedAt

  sessions                   Session[]
  audit_logs                 AuditLog[]

  @@map("app_users")
}

// Rôles disponibles (stockés comme String en base de données):
// - SUPER_ADMIN     : Tout accès - Super administrateur
// - DIRECTOR        : Lecture globale + validation
// - BRANCH_MANAGER  : Gestion agence
// - CREDIT_OFFICER  : Gestion crédits
// - TELLER          : Opérations caisse

/// Modules du système
enum ModuleType {
  CLIENT
  EPARGNE
  CREDIT
  GUICHET
  SYSTEME
  PARAMETRAGE
  RAPPORTS
  COMPTABILITE
  LIGNE_CREDIT
  BUDGET
}

/// Permissions granulaires
model Permission {
  id                         Int       @id @default(autoincrement())
  code                       String    @unique  // Ex: CLIENT_VIEW, CLIENT_CREATE
  name                       String             // Nom lisible
  description                String?
  module                     ModuleType

  created_at                 DateTime  @default(now())

  role_permissions           RolePermission[]

  @@map("app_permissions")
}

/// Association Rôle-Permission
model RolePermission {
  id                         Int        @id @default(autoincrement())
  role                       String
  permission_id              Int

  created_at                 DateTime   @default(now())

  permission                 Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@unique([role, permission_id])
  @@map("app_role_permissions")
}

/// Sessions utilisateurs
model Session {
  id                         String    @id @default(uuid())
  user_id                    Int

  refresh_token              String    @unique
  expires_at                 DateTime

  ip_address                 String?
  user_agent                 String?

  created_at                 DateTime  @default(now())

  user                       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("app_sessions")
}

/// Journal d'audit
model AuditLog {
  id                         Int       @id @default(autoincrement())
  user_id                    Int?

  action                     String    // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity                     String    // Client, Compte, etc.
  entity_id                  String?

  old_values                 Json?
  new_values                 Json?

  ip_address                 String?
  user_agent                 String?

  created_at                 DateTime  @default(now())

  user                       User?     @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([entity, entity_id])
  @@index([created_at])
  @@map("app_audit_logs")
}

/// Comptes clients pour l'app mobile (authentification séparée)
model ClientAuth {
  id                         Int       @id @default(autoincrement())
  id_client                  Int       @unique // Lien vers ad_cli

  phone_number               String    @unique
  pin_hash                   String

  is_active                  Boolean   @default(true)
  is_verified                Boolean   @default(false)

  last_login                 DateTime?
  failed_attempts            Int       @default(0)
  locked_until               DateTime?

  device_token               String?   // Pour notifications push

  created_at                 DateTime  @default(now())
  updated_at                 DateTime  @updatedAt

  @@map("app_client_auth")
}

// ============================================
// GESTION DE CAISSE
// ============================================

/// Session de caisse (ouverture/fermeture journalière)
model CaisseSession {
  id                         Int       @id @default(autoincrement())
  id_ag                      Int       // Agence
  user_id                    Int       // Caissier

  date_session               DateTime  @db.Date  // Date de la session

  // Ouverture
  heure_ouverture            DateTime?
  montant_ouverture          Decimal   @db.Decimal(30, 6) @default(0)
  decompte_ouverture_id      Int?      // Lien vers le décompte d'ouverture

  // Fermeture
  heure_fermeture            DateTime?
  montant_fermeture          Decimal?  @db.Decimal(30, 6)
  decompte_fermeture_id      Int?      // Lien vers le décompte de fermeture

  // Écarts
  ecart                      Decimal?  @db.Decimal(30, 6)  // Différence théorique vs réel
  commentaire_ecart          String?

  // Totaux de la journée
  total_entrees              Decimal   @db.Decimal(30, 6) @default(0)  // Total des dépôts/entrées
  total_sorties              Decimal   @db.Decimal(30, 6) @default(0)  // Total des retraits/sorties
  nombre_operations          Int       @default(0)

  // État: 1=Ouverte, 2=Fermée, 3=Validée par superviseur
  etat                       Int       @default(1)

  // Seuil maximal avant reversement obligatoire
  seuil_max                  Decimal?  @db.Decimal(30, 6)

  created_at                 DateTime  @default(now())
  updated_at                 DateTime  @updatedAt

  // Relations
  decomptes                  CaisseDecompte[]
  mouvements                 CaisseMouvement[]

  @@unique([id_ag, user_id, date_session])
  @@index([id_ag])
  @@index([user_id])
  @@index([date_session])
  @@map("app_caisse_sessions")
}

/// Décompte détaillé des billets et pièces
model CaisseDecompte {
  id                         Int       @id @default(autoincrement())
  session_id                 Int

  // Type: 1=Ouverture, 2=Fermeture, 3=Approvisionnement, 4=Reversement
  type_decompte              Int

  // Devise (ex: CDF, USD)
  devise                     String    @default("CDF") @db.VarChar(3)

  // Billets CDF (Franc Congolais)
  billets_20000              Int       @default(0)
  billets_10000              Int       @default(0)
  billets_5000               Int       @default(0)
  billets_1000               Int       @default(0)
  billets_500                Int       @default(0)
  billets_200                Int       @default(0)
  billets_100                Int       @default(0)
  billets_50                 Int       @default(0)

  // Pièces CDF
  pieces_50                  Int       @default(0)
  pieces_25                  Int       @default(0)
  pieces_10                  Int       @default(0)
  pieces_5                   Int       @default(0)
  pieces_1                   Int       @default(0)

  // Pour devises étrangères (USD, EUR, etc.)
  billets_100_usd            Int       @default(0)
  billets_50_usd             Int       @default(0)
  billets_20_usd             Int       @default(0)
  billets_10_usd             Int       @default(0)
  billets_5_usd              Int       @default(0)
  billets_1_usd              Int       @default(0)

  // Totaux calculés
  total_billets              Decimal   @db.Decimal(30, 6) @default(0)
  total_pieces               Decimal   @db.Decimal(30, 6) @default(0)
  total_general              Decimal   @db.Decimal(30, 6) @default(0)

  // Validation
  valide_par                 Int?      // ID du superviseur qui a validé
  date_validation            DateTime?

  commentaire                String?

  created_at                 DateTime  @default(now())

  // Relations
  session                    CaisseSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id])
  @@index([type_decompte])
  @@map("app_caisse_decomptes")
}

/// Mouvements de caisse (approvisionnement/reversement)
model CaisseMouvement {
  id                         Int       @id @default(autoincrement())
  session_id                 Int
  id_ag                      Int

  // Type: 1=Approvisionnement (entrée), 2=Reversement (sortie)
  type_mouvement             Int

  montant                    Decimal   @db.Decimal(30, 6)
  devise                     String    @default("CDF") @db.VarChar(3)

  // Source/Destination
  caisse_source_id           Int?      // ID de la session source (caisse principale)
  caisse_dest_id             Int?      // ID de la session destination

  // Référence à la caisse principale
  de_caisse_principale       Boolean   @default(false)
  vers_caisse_principale     Boolean   @default(false)

  // Validation
  demande_par                Int       // Caissier qui demande
  valide_par                 Int?      // Superviseur qui valide
  date_validation            DateTime?

  // État: 1=En attente, 2=Validé, 3=Rejeté
  etat                       Int       @default(1)

  motif_rejet                String?
  commentaire                String?

  // Référence document
  numero_bordereau           String?

  created_at                 DateTime  @default(now())

  // Relations
  session                    CaisseSession @relation(fields: [session_id], references: [id])

  @@index([session_id])
  @@index([id_ag])
  @@index([type_mouvement])
  @@index([etat])
  @@map("app_caisse_mouvements")
}

/// Configuration de la caisse principale par agence
model CaissePrincipale {
  id                         Int       @id @default(autoincrement())
  id_ag                      Int       @unique

  // Caissier principal assigné
  caissier_principal_id      Int?

  // Solde actuel
  solde_cdf                  Decimal   @db.Decimal(30, 6) @default(0)
  solde_usd                  Decimal   @db.Decimal(30, 6) @default(0)

  // Seuils
  seuil_min_cdf              Decimal?  @db.Decimal(30, 6)  // Alerte si en dessous
  seuil_max_cdf              Decimal?  @db.Decimal(30, 6)  // Alerte si au-dessus
  seuil_max_caissier_cdf     Decimal?  @db.Decimal(30, 6)  // Max qu'un caissier peut détenir

  seuil_min_usd              Decimal?  @db.Decimal(30, 6)
  seuil_max_usd              Decimal?  @db.Decimal(30, 6)
  seuil_max_caissier_usd     Decimal?  @db.Decimal(30, 6)

  created_at                 DateTime  @default(now())
  updated_at                 DateTime  @updatedAt

  @@map("app_caisse_principale")
}
